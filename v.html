<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>عرض مشروع</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html,body{height:100%;margin:0;font-family:Tahoma,Arial,sans-serif;background:#fff;color:#111}
    .layout{display:flex;height:100vh;gap:8px}
    #map{flex:1;min-height:200px;border-radius:6px;border:1px solid #e6e6e6}
    #side{width:360px;min-width:240px;padding:12px;border-right:1px solid #eee;box-sizing:border-box;direction:rtl;overflow:auto}
    h3{margin:0 0 8px;color:#1565c0}
    .muted{color:#666;font-size:13px}
    .link{word-break:break-all;background:#fafafa;border:1px dashed #e6e6e6;padding:8px;border-radius:4px}
    .error{background:#ffecec;border:1px solid #f5c6cb;color:#900;padding:8px;border-radius:4px;margin-top:8px;display:none}
    table{width:100%;border-collapse:collapse;font-size:13px;margin-top:8px}
    th,td{border:1px solid #eee;padding:6px;text-align:right}
    button{background:#1565c0;color:#fff;border:0;padding:8px 10px;border-radius:4px;cursor:pointer}
    button.secondary{background:#6c757d}
    .controls{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
    .small{font-size:12px;color:#777;margin-top:8px}
  </style>
</head>
<body>
  <div class="layout">
    <div id="map"></div>
    <aside id="side" aria-live="polite">
      <div style="margin-top:12px">
        <strong>معلومات المشروع</strong>
        <div id="props" class="muted">لا توجد بيانات بعد</div>
      </div>

    </aside>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // Helpers
    function showError(msg){
      const e = document.getElementById('error');
      e.style.display = 'block';
      e.textContent = msg;
      console.error(msg);
    }
    function clearError(){
      const e = document.getElementById('error');
      e.style.display = 'none';
      e.textContent = '';
    }
    function setDiag(msg){ document.getElementById('diagText').textContent = msg; }
    function escapeHtml(s){ return String(s).replace(/[&<>"'`=\/]/g, function(c){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#47;','`':'&#96;','=':'&#61;'}[c]); }); }

    // Map init
    let map;
    try {
      map = L.map('map', { zoomControl: true });
      L.tileLayer('https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', { attribution: '' }).addTo(map);
    } catch (e) {
      showError('فشل تهيئة خريطة Leaflet: ' + e.message);
    }

    // Params
    const params = new URLSearchParams(location.search);
    const compressed = params.get('data') || '';
    const titleParam = params.get('title') || '';
    const zoomParam = params.get('zoom') ? Number(params.get('zoom')) : null;
    const latParam = params.get('lat') ? Number(params.get('lat')) : null;
    const lngParam = params.get('lng') ? Number(params.get('lng')) : null;

    // Process data (expects compressed string produced by LZString.compressToEncodedURIComponent)
    if (!compressed) {
      setDiag('لم تُزوّد معلمة data مضغوطة.');
      document.getElementById('props').textContent = 'لا توجد بيانات.';
    } else {
      (function processCompressed(){
        clearError();
        setDiag('محاولة فك الضغط وفك JSON...');
        let jsonText = null;
        try {
          jsonText = LZString.decompressFromEncodedURIComponent(compressed);
          if (jsonText === null) throw new Error('قيمة data غير صالحة أو لم تُنشأ بواسطة compressToEncodedURIComponent');
        } catch (e) {
          showError('فشل فك الضغط: ' + (e && e.message ? e.message : String(e)));
          setDiag('تأكد أن المرسل استخدم LZString.compressToEncodedURIComponent.');
          return;
        }

        let gj;
        try {
          gj = JSON.parse(jsonText);
        } catch (e) {
          showError('فشل تحليل JSON بعد فك الضغط: ' + e.message);
          console.log('decoded preview:', (jsonText || '').slice(0,1000));
          return;
        }

        setDiag('GeoJSON صالح. عرض على الخريطة...');
        try {
          const geoLayer = L.geoJSON(gj, {
            style: function(){ return { color:'#2b7', weight:2, fillColor:'#bdf', fillOpacity:0.4 }; },
            pointToLayer: function(f, latlng){ return L.circleMarker(latlng, { radius:6, fillColor:'#1565c0', color:'#fff', weight:1, fillOpacity:1 }); },
            onEachFeature: function(feature, layer){
              // properties هنا مفاتيحها هي Alias مباشرة، لذا اعرض كل مفاتيح properties
              const propsObj = (feature && feature.properties) ? feature.properties : {};
              const rows = Object.keys(propsObj).map(k => ({ alias: k, value: propsObj[k] }));
              const popupHtml = renderRowsToTable(rows);
              layer.bindPopup('<div style="direction:rtl;text-align:right">' + popupHtml + '</div>');
              layer.on('click', function(){ showFeatureProps(feature, 'props'); });
            }
          }).addTo(map);

          // fitBounds (بعد مهلة صغيرة)
          setTimeout(function(){
            try {
              const bounds = geoLayer.getBounds();
              if (bounds && bounds.isValid && bounds.isValid()) {
                map.fitBounds(bounds.pad(0.05));
                setDiag('تمت إعادة التحجيم تلقائياً ليلائم البيانات.');
              } else {
                const features = gj.features || [];
                if (features.length === 1 && features[0].geometry && features[0].geometry.type === 'Point') {
                  const c = features[0].geometry.coordinates;
                  map.setView([c[1], c[0]], zoomParam || 16);
                  setDiag('البيانات نقطة واحدة، تم تعيين التكبير حولها.');
                } else {
                  setDiag('لا توجد حدود صالحة لعمل fitBounds.');
                }
              }
            } catch (e) {
              console.warn('fitBounds error', e);
              setDiag('فشل fitBounds: ' + (e && e.message ? e.message : String(e)));
            }
          }, 200);

          // افتراضي: عرض خصائص أول Feature (Alias keys)
          displayPropsSummary(gj);

          // جهّز رابط العرض المضغوط لكن لا تعرضه تلقائياً
          const shareUrl = location.origin + location.pathname + '?data=' + encodeURIComponent(compressed) + (titleParam ? ('&title=' + encodeURIComponent(titleParam)) : '') + (zoomParam ? ('&zoom=' + zoomParam) : '') + (latParam && lngParam ? ('&lat=' + latParam + '&lng=' + lngParam) : '');
          linkBox.textContent = shareUrl;
        } catch (e) {
          showError('فشل عرض GeoJSON: ' + (e && e.message ? e.message : String(e)));
        }
      })();
    }

    // Render helpers (keys already Alias)
    function renderRowsToTable(rows) {
      if (!rows || rows.length === 0) return '<div class="muted">لا توجد خصائص للعرض.</div>';
      let html = '<table><tbody>';
      rows.forEach(r => {
        html += '<tr><td>' + escapeHtml(String(r.alias)) + '</td><td>' + escapeHtml(String(r.value === undefined || r.value === null ? '' : r.value)) + '</td></tr>';
      });
      html += '</tbody></table>';
      return html;
    }

    function showFeatureProps(feature, targetElementOrId) {
      const targetEl = (typeof targetElementOrId === 'string') ? document.getElementById(targetElementOrId) : targetElementOrId;
      if (!targetEl) return;
      try {
        const propsObj = (feature && feature.properties) ? feature.properties : {};
        const rows = Object.keys(propsObj).map(k => ({ alias: k, value: propsObj[k] }));
        targetEl.innerHTML = renderRowsToTable(rows);
      } catch (e) {
        targetEl.textContent = 'خطأ في عرض الخصائص.';
        console.error(e);
      }
    }

    // displayPropsSummary: يعرض خصائص أول Feature (المفاتيح هي Alias)
    function displayPropsSummary(gj){
      try {
        const target = document.getElementById('props');
        if (!gj || !Array.isArray(gj.features) || gj.features.length === 0) {
          target.textContent = 'لا توجد فيتشرات.';
          return;
        }
        const firstFeature = gj.features[0];
        const propsObj = (firstFeature && firstFeature.properties) ? firstFeature.properties : {};
        const rows = Object.keys(propsObj).map(k => ({ alias: k, value: propsObj[k] }));
        target.innerHTML = renderRowsToTable(rows);
      } catch (e) {
        const target = document.getElementById('props');
        if (target) target.textContent = 'خطأ في عرض الخصائص.';
        console.error(e);
      }
    }

    // Buttons

    // Quick checks
    setTimeout(function(){
      try {
        console.log('Leaflet version:', L.version);
        const h = document.getElementById('map').offsetHeight;
        console.log('map container height:', h);
        if (!h || h < 50) setDiag('تحذير: ارتفاع حاوية الخريطة صغير. تأكد من CSS.');
      } catch(e){}
    }, 600);
  </script>
</body>
</html>
```