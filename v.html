<!doctype html>
<html lang="ar" dir="rtl">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>عرض مشروع</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="Style/style.css">
  <link rel="icon" href="favicon.ico" type="image/x-icon">
</head>

<body>
  <div class="layout">
    <div id="map"></div>
    <aside id="side" aria-live="polite">
      <div style="margin-top:12px">
        <strong>معلومات المشروع</strong>
        <div id="props" class="muted">لا توجد بيانات بعد</div>
      </div>

      <div id="linkBox" class="link" style="display:none;margin-top:10px"></div>

      <div id="diagnostics" style="margin-top:12px">
        <div id="diagText" class="muted" style="margin-top:6px">جارٍ التحميل...</div>
      </div>

      <div id="error" class="error"></div>


    </aside>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // Helpers
    function showError(msg) {
      const e = document.getElementById('error');
      e.style.display = 'block';
      e.textContent = msg;
    }
    function clearError() {
      const e = document.getElementById('error');
      e.style.display = 'none';
      e.textContent = '';
    }
    function setDiag(msg) { document.getElementById('diagText').textContent = msg; }
    function escapeHtml(s) { return String(s).replace(/[&<>"'`=\/]/g, function (c) { return ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;', '/': '&#47;', '`': '&#96;', '=': '&#61;' }[c]); }); }

    // Map init
    let map;
    try {
      map = L.map('map', { zoomControl: true });
      L.tileLayer('https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', { attribution: '' }).addTo(map);
    } catch (e) {
    }

    // Params
    const params = new URLSearchParams(location.search);
    const compressed = params.get('data') || '';
    const titleParam = params.get('title') || '';
    const zoomParam = params.get('zoom') ? Number(params.get('zoom')) : null;
    const latParam = params.get('lat') ? Number(params.get('lat')) : null;
    const lngParam = params.get('lng') ? Number(params.get('lng')) : null;

    // Process data (expects compressed string produced by LZString.compressToEncodedURIComponent)
    if (!compressed) {
      document.getElementById('props').textContent = 'لا توجد بيانات.';
    } else {
      (function processCompressed() {
        let jsonText = null;
        try {
          jsonText = LZString.decompressFromEncodedURIComponent(compressed);
          if (jsonText === null) throw new Error('');
        } catch (e) {
          return;
        }

        let gj;
        try {
          gj = JSON.parse(jsonText);
        } catch (e) {
          return;
        }

        try {
          const geoLayer = L.geoJSON(gj, {
            style: function () { return { color: 'green', weight: 2, fillColor: 'green', fillOpacity: 0.7 }; },
            pointToLayer: function (f, latlng) { return L.circleMarker(latlng, { radius: 6, fillColor: '#1565c0', color: '#fff', weight: 2, fillOpacity: 1 }); },
            onEachFeature: function (feature, layer) {
              // properties هنا مفاتيحها هي Alias مباشرة، لذا اعرض كل مفاتيح properties
              const propsObj = (feature && feature.properties) ? feature.properties : {};
              const rows = Object.keys(propsObj).map(k => ({ alias: k, value: propsObj[k] }));
              const popupHtml = renderRowsToTable(rows);
              layer.bindPopup('<div style="direction:rtl;text-align:right">' + popupHtml + '</div>');
              layer.on('click', function () { showFeatureProps(feature, 'props'); });
            }
          }).addTo(map);

          // fitBounds (بعد مهلة صغيرة)
          setTimeout(function () {
            try {
              const bounds = geoLayer.getBounds();
              if (bounds && bounds.isValid && bounds.isValid()) {
                map.fitBounds(bounds.pad(0.05));
              } else {
                const features = gj.features || [];
                if (features.length === 1 && features[0].geometry && features[0].geometry.type === 'Point') {
                  const c = features[0].geometry.coordinates;
                  map.setView([c[1], c[0]], zoomParam || 16);
                } else {
                }
              }
            } catch (e) {
            }
          }, 200);

          // افتراضي: عرض خصائص أول Feature (Alias keys)
          displayPropsSummary(gj);

          // جهّز رابط العرض المضغوط لكن لا تعرضه تلقائياً
          const shareUrl = location.origin + location.pathname + '?data=' + encodeURIComponent(compressed) + (titleParam ? ('&title=' + encodeURIComponent(titleParam)) : '') + (zoomParam ? ('&zoom=' + zoomParam) : '') + (latParam && lngParam ? ('&lat=' + latParam + '&lng=' + lngParam) : '');
          linkBox.textContent = shareUrl;
        } catch (e) {
        }
      })();
    }

    // Render helpers (keys already Alias)
    function renderRowsToTable(rows) {
      if (!rows || rows.length === 0) return '<div class="muted">لا توجد خصائص للعرض.</div>';
      let html = '<table>';
      rows.forEach(r => {
        html += '<tr><th style="background-color:#f0f0f0;">' + escapeHtml(String(r.alias)) + '</th><td>' + escapeHtml(String(r.value === undefined || r.value === null ? '' : r.value)) + '</td></tr>';
      });
      html += '</table>';
      return html;
    }

    function showFeatureProps(feature, targetElementOrId) {
      const targetEl = (typeof targetElementOrId === 'string') ? document.getElementById(targetElementOrId) : targetElementOrId;
      if (!targetEl) return;
      try {
        const propsObj = (feature && feature.properties) ? feature.properties : {};
        const rows = Object.keys(propsObj).map(k => ({ alias: k, value: propsObj[k] }));
        targetEl.innerHTML = renderRowsToTable(rows);
      } catch (e) {
        targetEl.textContent = '';
      }
    }

    // displayPropsSummary: يعرض خصائص أول Feature (المفاتيح هي Alias)
    function displayPropsSummary(gj) {
      try {
        const target = document.getElementById('props');
        if (!gj || !Array.isArray(gj.features) || gj.features.length === 0) {
          target.textContent = '';
          return;
        }
        const firstFeature = gj.features[0];
        const propsObj = (firstFeature && firstFeature.properties) ? firstFeature.properties : {};
        const rows = Object.keys(propsObj).map(k => ({ alias: k, value: propsObj[k] }));
        target.innerHTML = renderRowsToTable(rows);
      } catch (e) {
        const target = document.getElementById('props');
        if (target) target.textContent = '';
      }
    }

    setTimeout(function () {
      try {
        const h = document.getElementById('map').offsetHeight;
      } catch (e) { }
    }, 600);


</script>
</body>

</html>