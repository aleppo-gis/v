<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>عارض الطبقات المضغوطة</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html,body{height:100%;margin:0;font-family:Tahoma,Arial,sans-serif;background:#fff;color:#111}
    .layout{display:flex;height:100vh;gap:8px}
    #map{flex:1;min-height:200px;border-radius:6px;border:1px solid #e6e6e6}
    #side{width:360px;min-width:240px;padding:12px;border-right:1px solid #eee;box-sizing:border-box;direction:rtl;overflow:auto}
    h3{margin:0 0 8px;color:#1565c0}
    .muted{color:#666;font-size:13px}
    .link{word-break:break-all;background:#fafafa;border:1px dashed #e6e6e6;padding:8px;border-radius:4px}
    .error{background:#ffecec;border:1px solid #f5c6cb;color:#900;padding:8px;border-radius:4px;margin-top:8px;display:none}
    table{width:100%;border-collapse:collapse;font-size:13px;margin-top:8px}
    th,td{border:1px solid #eee;padding:6px;text-align:right}
    button{background:#1565c0;color:#fff;border:0;padding:8px 10px;border-radius:4px;cursor:pointer}
    button.secondary{background:#6c757d}
    .controls{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
    .small{font-size:12px;color:#777;margin-top:8px}
  </style>
</head>
<body>
  <div class="layout">
    <div id="map"></div>
    <aside id="side" aria-live="polite">
      <h3>عارض الطبقة (مضغوط)</h3>
      <div class="muted">تُقرأ معلمة <strong>data</strong> مضغوطة بواسطة LZ-String (compressToEncodedURIComponent).</div>

      <div style="margin-top:12px">
        <strong>معلومات مختصرة</strong>
        <div id="props" class="muted">لا توجد بيانات بعد</div>
      </div>

      <div class="controls">
        <button id="btnCopy">نسخ رابط العرض (مضغوط)</button>
        <button id="btnDownload" class="secondary">تنزيل GeoJSON</button>
        <button id="btnToggleLink" class="secondary" title="إظهار/إخفاء رابط العرض">إظهار الرابط</button>
      </div>

      <div id="linkBox" class="link" style="display:none;margin-top:10px"></div>

      <div id="diagnostics" style="margin-top:12px">
        <div class="muted">تشخيص سريع</div>
        <div id="diagText" class="muted" style="margin-top:6px">جارٍ الفحص...</div>
      </div>

      <div id="error" class="error"></div>
      <div class="small">معاملات اختيارية مدعومة: <code>title</code>, <code>zoom</code>, <code>lat</code>, <code>lng</code>.</div>
    </aside>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // --- Helpers ---
    function showError(msg){
      const e = document.getElementById('error');
      e.style.display = 'block';
      e.textContent = msg;
      console.error(msg);
    }
    function clearError(){
      const e = document.getElementById('error');
      e.style.display = 'none';
      e.textContent = '';
    }
    function setDiag(msg){ document.getElementById('diagText').textContent = msg; }
    function escapeHtml(s){ return String(s).replace(/[&<>"'`=\/]/g, function(c){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#47;','`':'&#96;','=':'&#61;'}[c]); }); }

    // --- Map init ---
    let map;
    try {
      map = L.map('map', { zoomControl: true });
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '' }).addTo(map);
    } catch (e) {
      showError('فشل تهيئة خريطة Leaflet: ' + e.message);
    }

    // --- Params ---
    const params = new URLSearchParams(location.search);
    const compressed = params.get('data') || '';
    const titleParam = params.get('title') || '';
    const zoomParam = params.get('zoom') ? Number(params.get('zoom')) : null;
    const latParam = params.get('lat') ? Number(params.get('lat')) : null;
    const lngParam = params.get('lng') ? Number(params.get('lng')) : null;

    const linkBox = document.getElementById('linkBox');
    const btnCopy = document.getElementById('btnCopy');
    const btnDownload = document.getElementById('btnDownload');
    const btnToggleLink = document.getElementById('btnToggleLink');

    // Toggle رابط العرض
    linkBox.style.display = 'none';
    btnToggleLink.addEventListener('click', function(){
      if (linkBox.style.display === 'none'){ linkBox.style.display = 'block'; btnToggleLink.textContent = 'إخفاء الرابط'; }
      else { linkBox.style.display = 'none'; btnToggleLink.textContent = 'إظهار الرابط'; }
    });

    // --- Process data ---
    if (!compressed) {
      setDiag('لم تُزوّد معلمة data مضغوطة.');
      document.getElementById('props').textContent = 'لا توجد بيانات.';
    } else {
      (function processCompressed(){
        clearError();
        setDiag('محاولة فك الضغط وفك JSON...');
        let jsonText = null;
        try {
          // نفترض أن المُرسِل استخدم compressToEncodedURIComponent
          jsonText = LZString.decompressFromEncodedURIComponent(compressed);
          if (jsonText === null) throw new Error('قيمة data غير صالحة أو لم تُنشأ بواسطة compressToEncodedURIComponent');
        } catch (e) {
          showError('فشل فك الضغط: ' + (e && e.message ? e.message : String(e)));
          setDiag('تأكد أن الرابط يُرسل قيمة data مضغوطة بصيغة compressToEncodedURIComponent.');
          return;
        }

        let gj;
        try {
          gj = JSON.parse(jsonText);
        } catch (e) {
          showError('فشل تحليل JSON بعد فك الضغط: ' + e.message);
          console.log('decoded preview:', (jsonText || '').slice(0,1000));
          return;
        }

        setDiag('GeoJSON صالح. عرض على الخريطة...');
        try {
          const geoLayer = L.geoJSON(gj, {
            style: function(){ return { color:'#d33', weight:2, fillColor:'#f99', fillOpacity:0.35 }; },
            pointToLayer: function(f, latlng){ return L.circleMarker(latlng, { radius:6, fillColor:'#1565c0', color:'#fff', weight:1, fillOpacity:1 }); },
            onEachFeature: function(feature, layer){
              // بناء popup يظهر الحقول المرئية المعرفة داخل الـ feature نفسه
              const rows = buildVisibleRowsFromFeature(feature);
              const popupHtml = renderRowsToTable(rows);
              layer.bindPopup('<div style="direction:rtl;text-align:right">' + popupHtml + '</div>');

              // عند النقر نعرض الخصائص في اللوحة الجانبية
              layer.on('click', function(){
                showFeatureProps(feature, 'props');
              });
            }
          }).addTo(map);

          // fitBounds بعد مهلة صغيرة لضمان تحميل البلاطات
          setTimeout(function(){
            try {
              const bounds = geoLayer.getBounds();
              if (bounds && bounds.isValid && bounds.isValid()) {
                map.fitBounds(bounds.pad(0.05));
                setDiag('تمت إعادة التحجيم تلقائياً ليلائم البيانات.');
              } else {
                const features = gj.features || [];
                if (features.length === 1 && features[0].geometry && features[0].geometry.type === 'Point') {
                  const c = features[0].geometry.coordinates;
                  map.setView([c[1], c[0]], zoomParam || 16);
                  setDiag('البيانات نقطة واحدة، تم تعيين التكبير حولها.');
                } else {
                  setDiag('لا توجد حدود صالحة لعمل fitBounds.');
                }
              }
            } catch (e) {
              console.warn('fitBounds error', e);
              setDiag('فشل fitBounds: ' + (e && e.message ? e.message : String(e)));
            }
          }, 200);

          // عرض خصائص أول فيتشر بشكل افتراضي
          displayPropsSummary(gj);

          // جهّز رابط العرض المضغوط لكن لا تعرضه تلقائياً
          const shareUrl = location.origin + location.pathname + '?data=' + encodeURIComponent(compressed) + (titleParam ? ('&title=' + encodeURIComponent(titleParam)) : '') + (zoomParam ? ('&zoom=' + zoomParam) : '') + (latParam && lngParam ? ('&lat=' + latParam + '&lng=' + lngParam) : '');
          linkBox.textContent = shareUrl;
        } catch (e) {
          showError('فشل عرض GeoJSON: ' + (e && e.message ? e.message : String(e)));
        }
      })();
    }

    // --- Visible fields helpers (كل Feature يحتوي __visible_fields__) ---
    function buildVisibleRowsFromFeature(feature) {
      const props = (feature && feature.properties) ? feature.properties : {};
      const vf = props.__visible_fields__;
      if (Array.isArray(vf) && vf.length > 0) {
        return vf.map(item => {
          if (!item || !item.name) return null;
          const key = String(item.name);
          if (!(key in props)) return null;
          const alias = (item.alias && String(item.alias)) || key;
          return { alias: alias, key: key, value: props[key] };
        }).filter(r => r !== null);
      }
      // fallback: عرض كل الحقول العامة
      const keys = Object.keys(props).filter(k => !k.startsWith('_') && k !== '__visible_fields__');
      return keys.map(k => ({ alias: k, key: k, value: props[k] }));
    }

    function renderRowsToTable(rows) {
      if (!rows || rows.length === 0) return '<div class="muted">لا توجد خصائص للعرض.</div>';
      let html = '<table><thead><tr><th>الحقل</th><th>القيمة</th></tr></thead><tbody>';
      rows.forEach(r => {
        html += '<tr><td>' + escapeHtml(String(r.alias)) + '</td><td>' + escapeHtml(String(r.value === undefined || r.value === null ? '' : r.value)) + '</td></tr>';
      });
      html += '</tbody></table>';
      return html;
    }

    function showFeatureProps(feature, targetElementOrId) {
      const targetEl = (typeof targetElementOrId === 'string') ? document.getElementById(targetElementOrId) : targetElementOrId;
      if (!targetEl) return;
      try {
        const rows = buildVisibleRowsFromFeature(feature);
        targetEl.innerHTML = renderRowsToTable(rows);
      } catch (e) {
        targetEl.textContent = 'خطأ في عرض الخصائص.';
        console.error(e);
      }
    }

    // --- displayPropsSummary: يعرض خصائص أول Feature اعتماداً على __visible_fields__ ---
    function displayPropsSummary(gj){
      try {
        const target = document.getElementById('props');
        if (!gj || !Array.isArray(gj.features) || gj.features.length === 0) {
          target.textContent = 'لا توجد فيتشرات.';
          return;
        }
        const firstFeature = gj.features[0];
        const rows = buildVisibleRowsFromFeature(firstFeature);
        target.innerHTML = renderRowsToTable(rows);
      } catch (e) {
        const target = document.getElementById('props');
        if (target) target.textContent = 'خطأ في عرض الخصائص.';
        console.error(e);
      }
    }

    // --- أزرار واجهة ---
    btnCopy.addEventListener('click', function(){
      if (!compressed){ alert('لا توجد بيانات للنسخ'); return; }
      const shareUrl = location.origin + location.pathname + '?data=' + encodeURIComponent(compressed) + (titleParam ? ('&title=' + encodeURIComponent(titleParam)) : '');
      if (navigator.clipboard) {
        navigator.clipboard.writeText(shareUrl).then(function(){ alert('تم نسخ رابط العرض'); }, function(){ prompt('انسخ الرابط يدوياً', shareUrl); });
      } else {
        prompt('انسخ الرابط', shareUrl);
      }
    });

    btnDownload.addEventListener('click', function(){
      if (!compressed){ alert('لا توجد بيانات'); return; }
      try {
        const jsonText = LZString.decompressFromEncodedURIComponent(compressed);
        const blob = new Blob([jsonText], { type: 'application/geo+json' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'layer.geojson';
        document.body.appendChild(a); a.click(); a.remove();
      } catch (e) { alert('فشل تنزيل GeoJSON: ' + (e && e.message ? e.message : String(e))); }
    });

    // فحص خفيف لـ Leaflet وارتفاع الخريطة
    setTimeout(function(){
      try {
        console.log('Leaflet version:', L.version);
        const h = document.getElementById('map').offsetHeight;
        console.log('map container height:', h);
        if (!h || h < 50) setDiag('تحذير: ارتفاع حاوية الخريطة صغير. تأكد من CSS.');
      } catch(e){}
    }, 600);
  </script>
</body>
</html>
```